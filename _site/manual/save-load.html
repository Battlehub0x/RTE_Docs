<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title> | Example Unity documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content=" | Example Unity documentation ">
    
      <link rel="shortcut icon" href="../favicon.ico">
      <link rel="stylesheet" href="../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../styles/docfx.css">
      <link rel="stylesheet" href="../styles/main.css">
      <meta property="docfx:navrel" content="../toc.html">
      <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">

<p>#Save Load Docs
##Overview</p>
<p>The <strong>Runtime Save &amp; Load</strong> (RTSL) subsystem is required for saving and managing scenes, assets and projects at runtime and consists of three main parts:</p>
<ul>
<li><a href="#persistent-classes">Persistent Classes</a> - this part allows you to choose what to serialize and generate persistent classes for serialization.</li>
<li><a href="#asset-library">Asset Libraries</a> - this part allows you to create and manage assets, as well as provide information to the RTSL to identify these assets.</li>
<li><a href="#project">Project</a> - this part provides api to interact with RTSL.</li>
</ul>
<div class="NOTE">
<h5>Note</h5>
<p>RTSL use <a href="https://github.com/mgravell/protobuf-net">protobuf.net</a> for serialization.</p>
</div>
<p><img src="../resources/img/save-load/get-started/demo2.png" alt="Screenshot"></p>
<p>##Getting Started</p>
<p>After importing RTSL you will see the configuration window:</p>
<p><img src="../resources/img/save-load/get-started/config-window.png" alt="Screenshot"></p>
<p>After clicking &quot;Build All&quot;, several folders will be created under <strong>/Battlehub/RTSL_Data</strong></p>
<p><img src="../resources/img/save-load/get-started/folders.png" alt="Screenshot"></p>
<ul>
<li><strong>Scripts</strong> for <a href="#persistent-classes">serializable persistent classes</a>.</li>
<li><strong>Custom Implementation</strong> for user defined persistent classes.</li>
<li><strong>Mappings</strong> for mappings between types that must be stored and serializable persistent types.</li>
<li><strong>Libraries</strong> for <a href="#asset-library">asset libraries and shader profiles</a>.</li>
</ul>
<div class="NOTE">
<h5>Note</h5>
<p><strong>RTSLTypeModel.dll</strong> contains <a href="https://github.com/mgravell/protobuf-net">protobuf-net</a> type model. Due to <a href="https://docs.unity3d.com/Manual/ScriptingRestrictions.html">unity scripting restrictions</a>, runtime type model need to be pre-complied before
using at runtime.</p>
</div>
<ol>
<li><p>Create a new scene.</p>
</li>
<li><p>Drag and Drop <strong>Assets/Battlehub/RTEditorDemo/Content/Runtime/RTEditor/DemoGame/<br>Prefabs/Game.prefab</strong> to hierarchy.</p>
<p><img src="../resources/img/save-load/get-started/game-prefab.png" alt="Screenshot">
<br><br></p>
</li>
<li><p>Click Tools-&gt;Runtime SaveLoad-&gt;<strong>Update Libraries</strong></p>
<p><img src="../resources/img/save-load/get-started/collect-scene-dependencies.png" alt="Screenshot">
<br><br></p>
</li>
<li><p>Click Tools-&gt;Runtime SaveLoad-&gt;<strong>Create RTSL</strong></p>
</li>
<li><p>Create <strong>RTSLExample</strong> script and add it to the Game Object created at previous step.</p>
</li>
<li><p>Hit play.</p>
</li>
<li><p>Save scene using 'M' key.</p>
</li>
<li><p>Load scene using 'L' key.</p>
</li>
</ol>
<pre><code class="lang-C#">
using System.Collections;

using UnityEngine;
using UnityEngine.SceneManagement;

using Battlehub.RTCommon;
using Battlehub.RTSL.Interface;


public class RTSLExample : MonoBehaviour
{
	IProject m_project;

	IEnumerator Start()
	{
		m_project = IOC.Resolve&lt;IProject&gt;();

		yield return m_project.OpenProject(&quot;My Project&quot;);
		yield return m_project.CreateFolder(&quot;Scenes/Demo&quot;);           
	}

	IEnumerator SaveScene()
	{
		ProjectAsyncOperation ao = m_project.Save(&quot;Scenes/Demo/Scene&quot;, SceneManager.GetActiveScene());
		yield return ao;

		if(ao.Error.HasError)
		{
			Debug.LogError(ao.Error.ToString());
		}
	}

	IEnumerator LoadScene()
	{
		ProjectAsyncOperation ao = m_project.Load&lt;Scene&gt;(&quot;Scenes/Demo/Scene&quot;);
		yield return ao;

		if (ao.Error.HasError)
		{
			Debug.LogError(ao.Error.ToString());
		}
	}

	void Update()
	{
		if (Input.GetKeyDown(KeyCode.M))
		{
			StartCoroutine(SaveScene());
		}

		if (Input.GetKeyDown(KeyCode.L))
		{   
			if (m_project.Exist&lt;Scene&gt;(&quot;Scenes/Demo/Scene&quot;))
			{
				StartCoroutine(LoadScene());
			}
		}
	}
}

</code></pre>
<p>Saved scene can be found in <a href="https://docs.unity3d.com/ScriptReference/Application-persistentDataPath.html"><strong>PersistentDataPath</strong></a><strong>/My Project/Assets/Scenes/Demo folder</strong>.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Only several persistent classes enabled by default. Use <a href="#persistent-classes">Persistent Classes Editor Window</a> to enable more.</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>Demo scene can be found in <strong>Assets/Battlehub/RTEditorDemo/Content/Runtime/RTSL</strong> folder.</p>
</div>
<p>##Persistent Classes</p>
<p><strong>Persistent Class</strong> is a class derived from <strong>Persistent Surrogate</strong> and has the <strong>[ProtoContract]</strong> attribute . The main purpose of persistent classes is to give you complete control over what to save and how to save, without having to use reflection and without writing a lot of boilerplate code.</p>
<p>To open persistent classes editor, click Tools-&gt;Runtime SaveLoad-&gt;<strong>Persistent Classes-&gt;Edit</strong>.</p>
<p><img src="../resources/img/save-load/persistent-classes/open-persistent-classes-editor.png" alt="Screenshot"></p>
<p>Here is the persistent classes editor window:</p>
<p><img src="../resources/img/save-load/persistent-classes/editor.png" alt="Screenshot"></p>
<p>This window allows you:</p>
<ul>
<li>Search for types you want to save.</li>
<li>Select properties you want to save.</li>
<li>Generate C# code of persistent classes.</li>
</ul>
<p>After clicking the <strong>&quot;Create Persistent Classes&quot;</strong> button the following will occur:</p>
<ol>
<li>Persistent classes will be created in
<strong>Assets/Battlehub/RTSL_Data/Scripts/PersistentClasses</strong>.</li>
</ol>
<pre><code>![Screenshot](~/resources/img/save-load/persistent-classes/persistent-classes-folder.png)
&lt;br/&gt;&lt;br/&gt;
</code></pre>
<ol start="2">
<li>The editor window state will be saved in
<strong>Assets/Battlehub/RTSL_Data/Mappings/Editor</strong>.</li>
</ol>
<pre><code>![Screenshot](~/resources/img/save-load/persistent-classes/mappings-folder.png)
&lt;br/&gt;&lt;br/&gt;
</code></pre>
<ol start="3">
<li>Custom Implementations will be created in <strong>.../RTSL_Data/Scripts/CustomImplementation</strong>.</li>
</ol>
<pre><code>![Screenshot](~/resources/img/save-load/persistent-classes/custom-implementation-folder.png)
&lt;br/&gt;&lt;br/&gt;
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>To ensure forward compatibility of saved files, never delete the <strong>ClassMappingStorage</strong> and <strong>SurrogatesMappingsStorage</strong> prefabs !!!</p>
</div>
<p>##How To: Create Custom Persistent Class</p>
<p>In some cases, it is not possible to obtain all data to be saved using public properties and fields. For example, some data can only be retrieved using methods.
If you need to write your own code to save and load data, follow these steps:</p>
<ol>
<li>Open Persistent Classes Editor.</li>
<li>Find and select required type.</li>
<li>Select <strong>&quot;Custom Implementation&quot;</strong></li>
</ol>
<pre><code>![Screenshot](~/resources/img/save-load/persistent-classes/create-custom-implementation.png)
&lt;br/&gt;&lt;br/&gt;
</code></pre>
<ol start="4">
<li>Click <strong>Create Persistent Classes</strong> button.</li>
<li>Click <strong>Edit Custom Implementation</strong> button.</li>
</ol>
<pre><code>![Screenshot](~/resources/img/save-load/persistent-classes/edit-custom-implementation.png)
&lt;br/&gt;&lt;br/&gt;
</code></pre>
<ol start="6">
<li>You should see following:</li>
</ol>
<pre><code class="lang-C#">#if !RTSL_MAINTENANCE
using Battlehub.RTSL;
namespace UnityEngine.Battlehub.SL2
{
    [CustomImplementation]
    public partial class PersistentJoint&lt;TID&gt;
    {
        /*
        public override void ReadFrom(object obj)
        {
            base.ReadFrom(obj);
        }

        public override object WriteTo(object obj)
        {
            return base.WriteTo(obj);
        }

        public override void GetDeps(GetDepsContext&lt;TID&gt; context)
        {
            base.GetDeps(context);
        }

        public override void GetDepsFrom(object obj, GetDepsFromContext context)
        {
            base.GetDepsFrom(obj, context);
        }
        */
    }
}
#endif

</code></pre>
<p>There are four methods that can be implemented:</p>
<ul>
<li><code>void ReadFrom(object obj)</code> - called before serialization. Read the data from obj and save it to the fields of the persistent object.</li>
<li><code>object WriteTo(object obj)</code> - called after deserialization. Write stored data to obj.</li>
<li><code>void GetDeps(GetDepsContext&lt;TID&gt; context)</code> - return IDs of dependencies.</li>
<li><code>void GetDepsFrom(object obj, GetDepsFromContext context)</code> - get dependencies from obj.</li>
</ul>
<p>Implementation of PersistentJoint may look like this:</p>
<pre><code class="lang-C#">
#if !RTSL_MAINTENANCE
using Battlehub.RTSL;
namespace UnityEngine.Battlehub.SL2
{
    [CustomImplementation]
    public partial class PersistentJoint&lt;TID&gt;
    {
        [ProtoBuf.ProtoMember(1)]
        private TID m_connectedBody;

        [ProtoBuf.ProtoMember(2)]
        private PersistentVector3&lt;TID&gt; m_anchor;

        //..... more fields

        public override void ReadFrom(object obj)
        {
            base.ReadFrom(obj);

            Joint joint = (Joint)obj;
            if (joint == null)
            {
                return;
            }

            m_connectedBody = ToID(joint.connectedBody);
            m_anchor = joint.anchor;

            //... read other fields
        }

        public override object WriteTo(object obj)
        {
            obj = base.WriteTo(obj);

            Joint joint = (Joint)obj;
            if (joint == null)
            {
                return obj;
            }

            joint.connectedBody = FromID&lt;Rigidbody&gt;(m_connectedBody);
            joint.anchor = m_anchor;

            //... write other fields

            return joint;
        }

        public override void GetDeps(GetDepsContext&lt;TID&gt; context)
        {
            base.GetDeps(context);

            AddDep(m_connectedBody, context);

            //... get other dependencies
        }

        public override void GetDepsFrom(object obj, GetDepsFromContext context)
        {
            base.GetDepsFrom(obj, context);

            Joint joint = (Joint)obj;
            if (joint == null)
            {
                return;
            }

            AddDep(joint.connectedBody, context);

            //... get other dependencies
        }
    }
}
#endif


</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>Click <strong>Tools-&gt; Runtime SaveLoad-&gt;Config-&gt;Build All</strong> every time you finish making changes to the persistent classes and are ready to build your application.</p>
</div>
<p>##Asset Library</p>
<p>Game objects in any scene refer assets such as materials, meshes, textures, etc.
Identifiers of these assets obtained using GetInstanceID() method do not remain constant and can change.<br>
<strong>Asset libraries</strong>, in contrast, are used to store unique asset identifiers that never change.</p>
<p>There are two special asset libraries:</p>
<ul>
<li>Built-in asset library - contains Unity build-in assets.</li>
<li>Scene asset library - contains assets referenced by scene Game Objects.</li>
</ul>
<p>Both libraries created automatically by clicking <strong>Tools-&gt;Runtime SaveLoad-&gt;Update Libraries</strong></p>
<p><img src="../resources/img/save-load/asset-libraries/special-asset-libraries.png" alt="Screenshot"></p>
<div class="NOTE">
<h5>Note</h5>
<p>Scene asset libraries are referenced using the scene name. This means that scenes must have unique names.</p>
</div>
<div class="NOTE">
<h5>Note</h5>
<p>Click <strong>Tools-&gt;Runtime SaveLoad-&gt;Update Libraries</strong> each time you have finished making changes to the scene and are ready to run the application.</p>
</div>
<p>##How To: Create Asset Library</p>
<p>If the built-in asset library and scene dependency library are not sufficient,
and the new resources must be <a href="https://docs.unity3d.com/ScriptReference/Resources.Load.html">Resource.Loaded</a> at runtime, you can create
a new asset library by clicking<br>
<strong>Create -&gt; Runtime SaveLoad -&gt; Runtime Asset Library</strong> in the context menu.</p>
<p><img src="../resources/img/save-load/asset-libraries/create-asset-library.png" alt="Screenshot"></p>
<div class="NOTE">
<h5>Note</h5>
<p>An asset library must be created inside the <strong>Resources</strong> folder.</p>
</div>
<p>Use drag &amp; drop to add assets to asset library</p>
<p><img src="../resources/img/save-load/asset-libraries/populate-asset-library.png" alt="Screenshot"></p>
<div class="NOTE">
<h5>Note</h5>
<p>One asset library can contain no more than <strong>65535</strong> assets.</p>
</div>
<p>If you change hierarchy of one or more prefabs, you will be asked to synchronize the assets library. Do it by clicking <strong>Synchronize</strong> button.</p>
<p><img src="../resources/img/save-load/asset-libraries/synchronize-asset-library.png" alt="Screenshot"></p>
<p>##Project Item &amp; Asset Item</p>
<p><strong>Project Items</strong> are used to create tree structures representing the project tree.</p>
<pre><code class="lang-C#">       [ProtoContract]
    [ProtoInclude(1, typeof(AssetItem))]
    public class ProjectItem
    {
        [ProtoMember(2)]
        public long ItemID;

        [ProtoMember(3)]
        public Guid ItemGUID;

        public string Name;
        public string Ext;

        public ProjectItem Parent;
        public List&lt;ProjectItem&gt; Children;

	    // ...

</code></pre>
<p><strong>Asset Items</strong> are meta representations of assets in a project. They are stored in *.rtmeta files.</p>
<pre><code class="lang-C#">
    [ProtoContract]
    public class AssetItem : ProjectItem
    {
        public event EventHandler PreviewDataChanged;

        [ProtoMember(1)]
        public Guid TypeGuid;

        [ProtoMember(2)]
        public PrefabPart[] Parts;

        [ProtoMember(3)]
        public long[] Dependencies;

        [ProtoMember(4, IsRequired = true)]
        public long CustomDataOffset = -1;

        [ProtoMember(5)]
        public Guid[] DependenciesGuids;


        private Preview m_preview;
        public Preview Preview
        {
            get { return m_preview; }
            set
            {
                if (m_preview != value)
                {
                    m_preview = value;
                    if (PreviewDataChanged != null)
                    {
                        PreviewDataChanged(this, EventArgs.Empty);
                    }
                }
            }
        }

        public override bool IsFolder
        {
            get { return false; }
        }

    }

</code></pre>
<p>##Project</p>
<p><strong>IProject</strong> is the main interface of the RTSL library. Here is how to access it:</p>
<pre><code class="lang-C#">
using Battlehub.RTCommon;
using Battlehub.RTSL.Interface;

void Awake()
{
	IProject project = IOC.Resolve&lt;IProject&gt;();
}

</code></pre>
<br>
Open project:
``` C#
<p>using System.Collections;
using Battlehub.RTCommon;
using Battlehub.RTSL.Interface;</p>
<p>IEnumerator Start()
{
IProject project = IOC.Resolve<iproject>();
yield return project.OpenProject(&quot;My Project&quot;);
}</iproject></p>
<pre><code>
&lt;br/&gt;
Close project:
``` C#
m_project.CloseProject();
</code></pre>
<br>
Delete project:
``` C#
yield return project.DeleteProject("My Project");
```
<br>
Create folder:
``` C#
yield return project.CreateFolder("My Scenes");   
```
<br>
Delete folder:
``` C#
yield return project.DeleteFolder("My Scenes");
```
<br>
Save scene:
``` C#
<p>using System.Collections;</p>
<p>using UnityEngine;
using UnityEngine.SceneManagement;</p>
<p>using Battlehub.RTCommon;
using Battlehub.RTSL.Interface;</p>
<p>IEnumerator Start()
{
//...</p>
<pre><code>ProjectAsyncOperation ao = project.Save(&quot;My Scenes/Scene 1&quot;, SceneManager.GetActiveScene());
yield return ao;
        
if (ao.Error.HasError)
{
	Debug.LogError(ao.Error.ToString());
}
</code></pre>
<p>}</p>
<pre><code>&lt;br/&gt;
Load scene:
``` C#

using System.Collections;

using UnityEngine;
using UnityEngine.SceneManagement;

using Battlehub.RTCommon;
using Battlehub.RTSL.Interface;

IEnumerator Start()
{
	//...
	
	ProjectAsyncOperation ao = project.Load&lt;Scene&gt;(&quot;My Scenes/Scene 1&quot;);
	yield return ao;
            
	if (ao.Error.HasError)
	{
		Debug.LogError(ao.Error.ToString());
	}
}

</code></pre>
<br>
Delete scene:
``` C#
yield return project.Delete<scene>("My Scenes/Scene 1");
```
<br>
Find objects of type:
``` C#
foreach(string scene in project.Find<scene>("Scene 1"))
{
	Debug.Log(scene);
}
<pre><code>
&lt;br/&gt;
Create Prefab:
``` C# 
GameObject primitive = GameObject.CreatePrimitive(PrimitiveType.Capsule);
yield return project.Save(&quot;Capsule&quot;, primitive);
Destroy(primitive);
</code></pre>
<br>
Load and instantiate Prefab:
``` C# 
ProjectAsyncOperation<object[]> ao = project.Load<gameobject>("Capsule");
yield return ao;
<p>if(!ao.Error.HasError)
{
Instantiate(ao.Result[0]);
}</p>
<pre><code>
&lt;br/&gt;
Import all assets from asset bundle:
``` C#

//get names of asset bundles from Assets/StreamingAssets folder.
ProjectAsyncOperation&lt;string[]&gt; ao = project.GetAssetBundles();
yield return ao;

//load ImportItems from first asset bundle
ProjectAsyncOperation&lt;ProjectItem&gt; loadAo = project.LoadImportItems(ao.Result[0], false);
yield return loadAo;


if (!loadAo.Error.HasError)
{
	//create previews here...
	//then unload asset bundle assets
	project.UnloadImportItems(loadAo.Result);

	//import all
	yield return project.Import(loadAo.Result.Flatten(true).OfType&lt;ImportItem&gt;().ToArray());
}

//log all asset items in project
foreach(string path in project.Find&lt;object&gt;(string.Empty, true))
{
	Debug.Log(path);
}
</code></pre>
</gameobject></object[]></scene></scene></article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/Battlehub0x/RTE_Docs/blob/main/docs/manual/save-load.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      Example Unity documentation
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
